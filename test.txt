import logging
import requests
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes

# ←←← توکن باتت رو اینجا بذار ←←←
BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"

# مختصات دقیق شهرها (دقیقاً همون‌هایی که سایت praytime-almahdyoon.com استفاده می‌کنه)
CITIES = {
    "تهران":   (35.7218583, 51.3346954),
    "مشهد":    (36.2970000, 59.6061000),
    "اصفهان":  (32.6539000, 51.6660000),
    "تبریز":   (38.0667000, 46.3000000),
    "اهواز":   (31.3183000, 48.6706000),
    "گرمسار": (35.2167000, 52.3167000),
}

logging.basicConfig(level=logging.INFO)

# نام‌های دقیق مطابق جدول سایت (کلید maghrib = اذان مغرب شرعی)
PRAYER_NAMES = {
    "imsak":    "الإمساك (امساک)",
    "fajr":     "الفجر (اذان صبح)",
    "sunrise":  "الشروق (طلوع آفتاب)",
    "dhuhr":    "الظهر (اذان ظهر)",
    "aasr":     "العصر (اذان عصر)",
    "maghrib":  "المغرب (اذان مغرب)",   # ← درست و شرعی (مثلاً 17:06)
    "midnight": "منتصف الليل (نیمه‌شب شرعی)"
}

def get_prayer_times(lat: float, lon: float):
    today = datetime.now()
    url = "https://www.praytime-almahdyoon.com/api/public/prayertimes/day"
    params = {
        "day": today.day,
        "month": today.month,
        "year": today.year,
        "latitude": lat,
        "longitude": lon,
        "timezone": 3.5,
        "languageCode": "en"
    }
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "Accept": "application/json, text/plain, */*",
        "Referer": "https://www.praytime-almahdyoon.com/",
        "Origin": "https://www.praytime-almahdyoon.com",
        "Sec-Fetch-Mode": "cors",
        "Sec-Fetch-Site": "same-origin"
    }

    try:
        session = requests.Session()
        session.get("https://www.praytime-almahdyoon.com/", headers=headers, timeout=10)
        r = session.get(url, params=params, headers=headers, timeout=15)
        if r.status_code == 200:
            data = r.json()
            if "imsak" in data:
                return data
    except Exception as e:
        logging.error(f"خطا: {e}")
    return None

# ------------------ /start ------------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("تهران", callback_data="تهران")],
        [InlineKeyboardButton("مشهد", callback_data="مشهد")],
        [InlineKeyboardButton("اصفهان", callback_data="اصفهان")],
        [InlineKeyboardButton("تبریز", callback_data="تبریز")],
        [InlineKeyboardButton("اهواز", callback_data="اهواز")],
        [InlineKeyboardButton("گرمسار", callback_data="گرمسار")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        "سلام! اوقات شرعی دقیق از praytime-almahdyoon.com\n\n"
        "شهر مورد نظرت رو انتخاب کن:",
        reply_markup=reply_markup
    )

# ------------------ دکمه‌ها ------------------
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    city = query.data
    lat, lon = CITIES[city]

    await query.edit_message_text(f"در حال دریافت اوقات شرعی {city}... ⏳")

    data = get_prayer_times(lat, lon)

    if not data:
        await query.edit_message_text("خطا در دریافت اطلاعات. چند دقیقه دیگه دوباره امتحان کن.")
        return

    date = data.get("date", datetime.now().strftime("%d/%m/%Y"))

    msg = f"اوقات شرعی امروز {city}\n{date}\n\n"
    order = ["imsak", "fajr", "sunrise", "dhuhr", "aasr", "maghrib", "midnight"]
    for key in order:
        if key in data and data[key]:
            msg += f"{PRAYER_NAMES[key]}: {data[key]}\n"

    await query.edit_message_text(msg.strip())

# ------------------ اجرا ------------------
def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(button_handler))
    print("ربات اوقات شرعی (کاملاً درست و به‌روز) فعال شد!")
    app.run_polling()

if __name__ == "__main__":
    main()
