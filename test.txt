import logging
import requests
from datetime import datetime
import jdatetime
import pytz
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from telegram import error as telegram_error

BOT_TOKEN = "Your_Token"

CITIES = {
    "اراک": (34.0873496, 49.7022387), "اردبیل": (38.24317569999999, 48.2976116), "ارومیه": (37.5498061, 45.0786282),
    "اصفهان": (32.6538966, 51.66596560000001), "اهواز": (31.3183272, 48.6706187), "ایلام": (33.6349736, 46.415281),
    "بجنورد": (37.4744863, 57.3233079), "بندرعباس": (27.1962543, 56.2883647), "بوشهر": (28.9144913, 50.8279019),
    "بیرجند": (32.8733165, 59.216293), "تبریز": (38.0791831, 46.2886732), "تهران": (35.7218583, 51.3346954),
    "خرم‌آباد": (33.4646833, 48.33896439999999), "رشت": (37.2712671, 49.5920736), "زاهدان": (29.4893049, 60.8639982),
    "زنجان": (36.6830045, 48.5087209), "ساری": (36.5658729, 53.0586328), "سمنان": (35.5767039, 35.5767039),
    "سنندج": (35.3219, 46.9925), "شهرکرد": (32.3256, 50.8644), "شیراز": (29.5917, 52.5833),
    "قزوین": (36.2688, 50.0041), "قم": (34.6399, 50.8759), "کرج": (35.8400, 50.9391),
    "کرمان": (30.2833, 57.0833), "کرمانشاه": (34.3142, 47.0650), "گرگان": (36.8387, 54.4346),
    "مشهد": (36.2970, 59.6061), "همدان": (34.7992, 48.5147), "یاسوج": (30.6667, 51.5833),
    "یزد": (31.8974, 54.3569),
    "آزادشهر": (37.0870, 55.1742), "تربت حیدریه": (35.2740, 59.2195), "چناران": (36.6455, 59.1255),
    "دامغان": (36.1667, 54.3833), "دزفول": (32.3839747, 48.399618), "سبزوار": (36.2000, 57.7167),
    "شاهرود": (36.4182, 54.9763), "گلبهار": (36.5699, 59.1616), "ماهشهر": (30.5500, 49.1833),
    "ملایر": (34.2969, 48.8235), "میانرود": (36.5493011, 52.3385457),
    "بامیان": (34.8216, 67.8225), "غزنی": (33.5479, 68.4226), "کابل": (34.5439, 69.1607),
    "هرات": (34.3430, 62.1991), "شوشتر": (32.0465314, 48.8550226), "گرمسار": (35.2207116, 52.3390856),
}

logging.basicConfig(level=logging.INFO)

PRAYER_NAMES = {
    "imsak": "الإمساك (امساک)",
    "fajr": "الفجر (اذان صبح)",
    "sunrise": "الشروق (طلوع آفتاب)",
    "dhuhr": "الظهر (اذان ظهر)",
    "aasr": "العصر (اذان عصر)",
    "maghrib": "غروب خورشید",  # غروب نجومی
    # اذان مغرب شرعی — دقیق مثل سایت
    "preferrableMaghrib": "المغرب (اذان مغرب)",
    "midnight": "منتصف الليل (نیمه‌شب شرعی)"
}


def get_prayer_times(lat: float, lon: float):
    today = datetime.now()
    url = "https://www.praytime-almahdyoon.com/api/public/prayertimes/day"
    params = {
        "day": today.day, "month": today.month, "year": today.year,
        "latitude": lat, "longitude": lon, "timezone": 3.5, "languageCode": "en"
    }
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "Accept": "application/json, text/plain, */*",
        "Referer": "https://www.praytime-almahdyoon.com/",
        "Origin": "https://www.praytime-almahdyoon.com",
    }

    try:
        session = requests.Session()
        session.get("https://www.praytime-almahdyoon.com/",
                    headers=headers, timeout=10)
        r = session.get(url, params=params, headers=headers, timeout=20)
        if r.status_code == 200:
            data = r.json()
            if "imsak" in data:
                return data
    except Exception as e:
        logging.error(f"خطا: {e}")
    return None


main_keyboard = ReplyKeyboardMarkup(
    [[KeyboardButton("انتخاب شهر")]], resize_keyboard=True)


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "به ربات دریافت اوقات شرعی روزانه خوش آمدید\n\nاطلاعات بر پایه سایت المهدیون میباشد.",
        reply_markup=main_keyboard
    )


async def show_cities(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.text != "انتخاب شهر":
        return
    cities = sorted(CITIES.keys())
    keyboard = []
    row = []
    for i, city in enumerate(cities, 1):
        row.append(InlineKeyboardButton(city, callback_data=city))
        if i % 3 == 0 or i == len(cities):
            keyboard.append(row)
            row = []
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("شهر مورد نظرت رو انتخاب کن:", reply_markup=reply_markup)


async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    city = query.data
    lat, lon = CITIES[city]

    try:
        await query.edit_message_text(f"در حال دریافت اوقات شرعی {city}... ⏳")
    except telegram_error.BadRequest as e:
        if "Message is not modified" not in str(e):
            raise

    data = get_prayer_times(lat, lon)

    if not data:
        await query.edit_message_text("خطا در دریافت اطلاعات. چند دقیقه دیگه امتحان کن.")
        return

    tehran_tz = pytz.timezone('Asia/Tehran')
    now_tehran = datetime.now(tehran_tz)
    jalali_date = jdatetime.datetime.fromgregorian(datetime=now_tehran)
    persian_date = jalali_date.strftime("%d %B %Y")

    msg = f"اوقات شرعی امروز {city}\n{persian_date}\n\n"
    order = ["imsak", "fajr", "sunrise", "dhuhr", "aasr",
             "maghrib", "preferrableMaghrib", "midnight"]
    for key in order:
        if key in data and data[key]:
            msg += f"{PRAYER_NAMES.get(key, key)}: {data[key]}\n"

    await query.edit_message_text(msg.strip())


def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(
        filters.TEXT & ~filters.COMMAND, show_cities))
    app.add_handler(CallbackQueryHandler(button_handler))
    print("ربات اوقات شرعی — نسخه نهایی با preferrableMaghrib — فعال شد!")
    app.run_polling()


if __name__ == "__main__":
    main()
