import logging
import requests
from datetime import datetime
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes

# ØªÙˆÚ©Ù† Ø¨Ø§Øª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø°Ø§Ø±
BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"

# Ù…Ø®ØªØµØ§Øª ØªÙ‡Ø±Ø§Ù† (Ø§Ø² Ø®ÙˆØ¯ Ø³Ø§ÛŒØª)
LAT = 35.7218583
LON = 51.3346954

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Ù†Ø§Ù… Ù†Ù…Ø§Ø²Ù‡Ø§ (Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ø·Ø§Ø¨Ù‚ JSON ÙˆØ§Ù‚Ø¹ÛŒ)
PRAYER_NAMES = {
    "imsak": "Ø§Ù…Ø³Ø§Ú©",
    "fajr": "Ø§Ø°Ø§Ù† ØµØ¨Ø­",
    "sunrise": "Ø·Ù„ÙˆØ¹ Ø¢ÙØªØ§Ø¨",
    "dhuhr": "Ø§Ø°Ø§Ù† Ø¸Ù‡Ø±",
    "aasr": "Ø§Ø°Ø§Ù† Ø¹ØµØ±",
    "maghrib": "Ø§Ø°Ø§Ù† Ù…ØºØ±Ø¨",
    "midnight": "Ù†ÛŒÙ…Ù‡â€ŒØ´Ø¨ Ø´Ø±Ø¹ÛŒ"
}

def get_prayer_times():
    today = datetime.now()
    url = "https://www.praytime-almahdyoon.com/api/public/prayertimes/day"
    params = {
        "day": today.day,
        "month": today.month,
        "year": today.year,
        "latitude": LAT,
        "longitude": LON,
        "timezone": 3.5,
        "languageCode": "en"
    }
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36",
        "Accept": "application/json, text/plain, */*",
        "Referer": "https://www.praytime-almahdyoon.com/",
        "Origin": "https://www.praytime-almahdyoon.com",
        "Sec-Fetch-Mode": "cors",
        "Sec-Fetch-Site": "same-origin"
    }

    try:
        session = requests.Session()
        session.get("https://www.praytime-almahdyoon.com/", headers=headers, timeout=10)  # Ú¯Ø±Ù… Ú©Ø±Ø¯Ù†
        r = session.get(url, params=params, headers=headers, timeout=15)
        
        if r.status_code == 200:
            data = r.json()
            if "imsak" in data:
                return data
    except Exception as e:
        logger.error(f"Ø®Ø·Ø§: {e}")
    return None

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_chat_action("typing")
    await update.message.reply_text("Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§ÙˆÙ‚Ø§Øª Ø´Ø±Ø¹ÛŒ Ø§Ù…Ø±ÙˆØ² ØªÙ‡Ø±Ø§Ù†... â³")

    data = get_prayer_times()

    if not data:
        await update.message.reply_text(
            "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ø³Ø§ÛŒØª ğŸ˜”\n\n"
            "Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ù‡ Ø¯ÙˆØ¨Ø§Ø±Ù‡ /start Ø¨Ø²Ù† ÛŒØ§ VPN Ø±Ùˆ Ú†Ú© Ú©Ù†."
        )
        return

    date = data.get("date", f"{datetime.now():%d/%m/%Y}")

    msg = f"Ø§ÙˆÙ‚Ø§Øª Ø´Ø±Ø¹ÛŒ Ø§Ù…Ø±ÙˆØ² ØªÙ‡Ø±Ø§Ù†\n"
    msg += f"{date}\n\n"
    order = ["imsak", "fajr", "sunrise", "dhuhr", "aasr", "maghrib", "midnight"]
    for key in order:
        if key in data and data[key]:
            msg += f"{PRAYER_NAMES[key]}: {data[key]}\n"

    await update.message.reply_text(msg.strip())

def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    print("Ø¨Ø§Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª â€“ ÙÙ‚Ø· /start Ø¨Ø²Ù†!")
    app.run_polling()

if __name__ == "__main__":
    main()
