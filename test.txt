import logging
import requests
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes

BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"

CITIES = {
    "Ø§Ø±Ø§Ú©": (34.0807, 49.7013), "Ø§Ø±Ø¯Ø¨ÛŒÙ„": (38.2500, 48.3000), "Ø§Ø±ÙˆÙ…ÛŒÙ‡": (37.5553, 45.0750),
    "Ø§ØµÙÙ‡Ø§Ù†": (32.6539, 51.6660), "Ø§Ù‡ÙˆØ§Ø²": (31.3183, 48.6706), "Ø§ÛŒÙ„Ø§Ù…": (33.6375, 46.4156),
    "Ø¨Ø¬Ù†ÙˆØ±Ø¯": (37.4750, 57.3333), "Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³": (27.1833, 56.2667), "Ø¨ÙˆØ´Ù‡Ø±": (28.9684, 50.8360),
    "Ø¨ÛŒØ±Ø¬Ù†Ø¯": (32.8667, 59.2167), "ØªØ¨Ø±ÛŒØ²": (38.0667, 46.3000), "ØªÙ‡Ø±Ø§Ù†": (35.7219, 51.3347),
    "Ø®Ø±Ù…â€ŒØ¢Ø¨Ø§Ø¯": (33.4878, 48.3558), "Ø±Ø´Øª": (37.2808, 49.5832), "Ø²Ø§Ù‡Ø¯Ø§Ù†": (29.4964, 60.8629),
    "Ø²Ù†Ø¬Ø§Ù†": (36.6667, 48.4833), "Ø³Ø§Ø±ÛŒ": (36.5633, 53.0600), "Ø³Ù…Ù†Ø§Ù†": (35.5769, 53.3922),
    "Ø³Ù†Ù†Ø¯Ø¬": (35.3219, 46.9925), "Ø´Ù‡Ø±Ú©Ø±Ø¯": (32.3256, 50.8644), "Ø´ÛŒØ±Ø§Ø²": (29.5926, 52.5836),
    "Ù‚Ø²ÙˆÛŒÙ†": (36.2688, 50.0041), "Ù‚Ù…": (34.6399, 50.8759), "Ú©Ø±Ø¬": (35.8400, 50.9391),
    "Ú©Ø±Ù…Ø§Ù†": (30.2833, 57.0833), "Ú©Ø±Ù…Ø§Ù†Ø´Ø§Ù‡": (34.3142, 47.0650), "Ú¯Ø±Ú¯Ø§Ù†": (36.8387, 54.4346),
    "Ù…Ø´Ù‡Ø¯": (36.2970, 59.6061), "Ù‡Ù…Ø¯Ø§Ù†": (34.7992, 48.5147), "ÛŒØ§Ø³ÙˆØ¬": (30.6667, 51.5833),
    "ÛŒØ²Ø¯": (31.8974, 54.3569),
    "Ø¢Ø²Ø§Ø¯Ø´Ù‡Ø±": (37.0870, 55.1742), "ØªØ±Ø¨Øª Ø­ÛŒØ¯Ø±ÛŒÙ‡": (35.2740, 59.2195), "Ú†Ù†Ø§Ø±Ø§Ù†": (36.6455, 59.1255),
    "Ø¯Ø§Ù…ØºØ§Ù†": (36.1667, 54.3833), "Ø¯Ø²ÙÙˆÙ„": (32.5667, 48.7833), "Ø³Ø¨Ø²ÙˆØ§Ø±": (36.2000, 57.7167),
    "Ø´Ø§Ù‡Ø±ÙˆØ¯": (36.4182, 54.9763), "Ú¯Ù„Ø¨Ù‡Ø§Ø±": (36.5699, 59.1616), "Ù…Ø§Ù‡Ø´Ù‡Ø±": (30.5500, 49.1833),
    "Ù…Ù„Ø§ÛŒØ±": (34.2969, 48.8235), "Ù…ÛŒØ§Ù†Ø±ÙˆØ¯": (36.5833, 52.9167),
    "Ø¨Ø§Ù…ÛŒØ§Ù†": (34.8216, 67.8225), "ØºØ²Ù†ÛŒ": (33.5479, 68.4226), "Ú©Ø§Ø¨Ù„": (34.5439, 69.1607),
    "Ù‡Ø±Ø§Øª": (34.3430, 62.1991),
}

logging.basicConfig(level=logging.INFO)

PRAYER_NAMES = {
    "imsak": "Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ (Ø§Ù…Ø³Ø§Ú©)",
    "fajr": "Ø§Ù„ÙØ¬Ø± (Ø§Ø°Ø§Ù† ØµØ¨Ø­)",
    "sunrise": "Ø§Ù„Ø´Ø±ÙˆÙ‚ (Ø·Ù„ÙˆØ¹ Ø¢ÙØªØ§Ø¨)",
    "dhuhr": "Ø§Ù„Ø¸Ù‡Ø± (Ø§Ø°Ø§Ù† Ø¸Ù‡Ø±)",
    "aasr": "Ø§Ù„Ø¹ØµØ± (Ø§Ø°Ø§Ù† Ø¹ØµØ±)",
    "sunset": "ØºØ±ÙˆØ¨ Ø®ÙˆØ±Ø´ÛŒØ¯",
    "maghrib_manual": "Ø§Ù„Ù…ØºØ±Ø¨ (Ø§Ø°Ø§Ù† Ù…ØºØ±Ø¨)",
    "midnight": "Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ (Ù†ÛŒÙ…Ù‡â€ŒØ´Ø¨ Ø´Ø±Ø¹ÛŒ)"
}

def get_minutes_based_on_lat(lat: float) -> float:
    """Ø¯Ù‚ÛŒÙ‚Ù‡ + Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ (Ø¨Ø±Ø§ÛŒ Ø±Ù†Ø¯ Ú©Ø±Ø¯Ù† Ø¯Ù‚ÛŒÙ‚)"""
    if lat > 35:
        return 15.5  # +15 Ø¯Ù‚ÛŒÙ‚Ù‡ + 30 Ø«Ø§Ù†ÛŒÙ‡ (Ø§Ø±Ø¯Ø¨ÛŒÙ„)
    elif lat > 30:
        return 14.5  # +14 Ø¯Ù‚ÛŒÙ‚Ù‡ + 30 Ø«Ø§Ù†ÛŒÙ‡ (Ø´ÛŒØ±Ø§Ø²)
    else:
        return 13.75  # +13 Ø¯Ù‚ÛŒÙ‚Ù‡ + 45 Ø«Ø§Ù†ÛŒÙ‡ (Ø¨ÙˆØ´Ù‡Ø±)

def add_minutes(time_str: str, minutes: float) -> str:
    try:
        h, m = map(int, time_str.split(":"))
        total_minutes = h * 60 + m + minutes
        new_h = int(total_minutes // 60) % 24
        new_m = int(total_minutes % 60)
        return f"{new_h:02d}:{new_m:02d}"
    except:
        return "Ù†Ø§Ù…Ø´Ø®Øµ"

def get_prayer_times(lat: float, lon: float):
    today = datetime.now()
    url = "https://www.praytime-almahdyoon.com/api/public/prayertimes/day"
    params = {
        "day": today.day, "month": today.month, "year": today.year,
        "latitude": lat, "longitude": lon, "timezone": 3.5, "languageCode": "en"
    }
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "Accept": "application/json, text/plain, */*",
        "Referer": "https://www.praytime-almahdyoon.com/",
        "Origin": "https://www.praytime-almahdyoon.com",
    }

    try:
        session = requests.Session()
        session.get("https://www.praytime-almahdyoon.com/", headers=headers, timeout=10)
        r = session.get(url, params=params, headers=headers, timeout=20)
        if r.status_code == 200:
            data = r.json()
            if "imsak" in data:
                if "maghrib" in data:
                    data["sunset"] = data["maghrib"]
                    minutes = get_minutes_based_on_lat(lat)
                    data["maghrib_manual"] = add_minutes(data["maghrib"], minutes)
                return data
    except Exception as e:
        logging.error(f"Ø®Ø·Ø§: {e}")
    return None

main_keyboard = ReplyKeyboardMarkup(
    [[KeyboardButton("Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±")]], 
    resize_keyboard=True
)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¯Ø±ÛŒØ§ÙØª Ø§ÙˆÙ‚Ø§Øª Ø´Ø±Ø¹ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯\n\n"
        "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø± Ù¾Ø§ÛŒÙ‡ Ø³Ø§ÛŒØª Ø§Ù„Ù…Ù‡Ø¯ÛŒÙˆÙ† Ù…ÛŒØ¨Ø§Ø´Ø¯.",
        reply_markup=main_keyboard
    )

async def show_cities(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.text != "Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±":
        return
    
    cities = sorted(CITIES.keys())
    keyboard = []
    row = []
    for i, city in enumerate(cities, 1):
        row.append(InlineKeyboardButton(city, callback_data=city))
        if i % 3 == 0 or i == len(cities):
            keyboard.append(row)
            row = []
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("Ø´Ù‡Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±Øª Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:", reply_markup=reply_markup)

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    city = query.data
    lat, lon = CITIES[city]

    await query.edit_message_text(f"Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§ÙˆÙ‚Ø§Øª Ø´Ø±Ø¹ÛŒ {city}...")

    data = get_prayer_times(lat, lon)

    if not data:
        await query.edit_message_text("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª. Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.")
        return

    # ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
    greg_date = datetime.now()
    jalali_date = jdatetime.fromgregorian(date=greg_date)
    persian_date = jalali_date.strftime("%d %B %Y")  # Ù…Ø«Ù„ "16 Ø¢Ø°Ø± 1403"

    msg = f"Ø§ÙˆÙ‚Ø§Øª Ø´Ø±Ø¹ÛŒ Ø§Ù…Ø±ÙˆØ² {city}\nğŸ“… {persian_date}\n\n"
    order = ["imsak", "fajr", "sunrise", "dhuhr", "aasr", "sunset", "maghrib_manual", "midnight"]
    for key in order:
        if key in data and data[key]:
            msg += f"{PRAYER_NAMES.get(key, key)}: {data[key]}\n"

    await query.edit_message_text(msg.strip())

def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, show_cities))
    app.add_handler(CallbackQueryHandler(button_handler))
    print("Ø±Ø¨Ø§Øª Ø§ÙˆÙ‚Ø§Øª Ø´Ø±Ø¹ÛŒ â€” Ø¨Ø§ ÙØ±Ù…ÙˆÙ„ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ù…ØºØ±Ø¨ â€” ÙØ¹Ø§Ù„ Ø´Ø¯!")
    app.run_polling()

if __name__ == "__main__":
    main()
