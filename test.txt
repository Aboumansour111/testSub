import logging
import requests
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes

BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"

# همه شهرها با مختصات دقیق + timezone (ایران 3.5, افغانستان 4.5)
CITIES = {
    # مراکز استان ایران (timezone 3.5)
    "اراک": (34.0807, 49.7013, 3.5), "اردبیل": (38.2500, 48.3000, 3.5), "ارومیه": (37.5553, 45.0750, 3.5),
    "اصفهان": (32.6539, 51.6660, 3.5), "اهواز": (31.3183, 48.6706, 3.5), "ایلام": (33.6375, 46.4156, 3.5),
    "بجنورد": (37.4750, 57.3333, 3.5), "بندرعباس": (27.1833, 56.2667, 3.5), "بوشهر": (28.9684, 50.8360, 3.5),
    "بیرجند": (32.8667, 59.2167, 3.5), "تبریز": (38.0667, 46.3000, 3.5), "تهران": (35.7219, 51.3347, 3.5),
    "خرم‌آباد": (33.4878, 48.3558, 3.5), "رشت": (37.2808, 49.5832, 3.5), "زاهدان": (29.4964, 60.8629, 3.5),
    "زنجان": (36.6667, 48.4833, 3.5), "ساری": (36.5633, 53.0600, 3.5), "سمنان": (35.5769, 53.3922, 3.5),
    "سنندج": (35.3219, 46.9925, 3.5), "شهرکرد": (32.3256, 50.8644, 3.5), "شیراز": (29.5926, 52.5836, 3.5),
    "قزوین": (36.2688, 50.0041, 3.5), "قم": (34.6399, 50.8759, 3.5), "کرج": (35.8400, 50.9391, 3.5),
    "کرمان": (30.2833, 57.0833, 3.5), "کرمانشاه": (34.3142, 47.0650, 3.5), "گرگان": (36.8387, 54.4346, 3.5),
    "مشهد": (36.2970, 59.6061, 3.5), "همدان": (34.7992, 48.5147, 3.5), "یاسوج": (30.6667, 51.5833, 3.5),
    "یزد": (31.8974, 54.3569, 3.5),
    # شهرهای جدید ایران (timezone 3.5)
    "آزادشهر": (37.0870, 55.1742, 3.5), "تربت حیدریه": (35.2740, 59.2195, 3.5), "چناران": (36.6455, 59.1255, 3.5),
    "دامغان": (36.1667, 54.3833, 3.5), "دزفول": (32.5667, 48.7833, 3.5), "سبزوار": (36.2000, 57.7167, 3.5),
    "شاهرود": (36.4182, 54.9763, 3.5), "گلبهار": (36.5699, 59.1616, 3.5), "ماهشهر": (30.5500, 49.1833, 3.5),
    "ملایر": (34.2969, 48.8235, 3.5), "میانرود": (36.5833, 52.9167, 3.5),
    # شهرهای افغانستان (timezone 4.5)
    "بامیان": (34.8216, 67.8225, 4.5), "غزنی": (33.5479, 68.4226, 4.5), "کابل": (34.5439, 69.1607, 4.5),
    "هرات": (34.3430, 62.1991, 4.5),
}

logging.basicConfig(level=logging.INFO)

PRAYER_NAMES = {
    "imsak": "الإمساك (امساک)",
    "fajr": "الفجر (اذان صبح)",
    "sunrise": "الشروق (طلوع آفتاب)",
    "dhuhr": "الظهر (اذان ظهر)",
    "aasr": "العصر (اذان عصر)",
    "sunset": "غروب خورشید",
    "maghrib_manual": "المغرب (اذان مغرب)",
    "midnight": "منتصف الليل (نیمه‌شب شرعی)"
}

def get_minutes_based_on_lat(lat: float) -> int:
    if lat > 35:
        return 15  # شمال (تهران، مشهد)
    elif lat > 30:
        return 14  # مرکز (شیراز)
    else:
        return 13  # جنوب (بوشهر)

def add_minutes(time_str: str, minutes: int) -> str:
    try:
        h, m = map(int, time_str.split(":"))
        total = h * 60 + m + minutes
        new_h = (total // 60) % 24
        new_m = total % 60
        return f"{new_h:02d}:{new_m:02d}"
    except:
        return "نامشخص"

def get_prayer_times(lat: float, lon: float, timezone: float):
    today = datetime.now()
    url = "https://www.praytime-almahdyoon.com/api/public/prayertimes/day"
    params = {
        "day": today.day, "month": today.month, "year": today.year,
        "latitude": lat, "longitude": lon, "timezone": timezone, "languageCode": "en"
    }
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "Accept": "application/json, text/plain, */*",
        "Referer": "https://www.praytime-almahdyoon.com/",
        "Origin": "https://www.praytime-almahdyoon.com",
    }

    try:
        session = requests.Session()
        session.get("https://www.praytime-almahdyoon.com/", headers=headers, timeout=10)
        r = session.get(url, params=params, headers=headers, timeout=20)
        if r.status_code == 200:
            data = r.json()
            if "imsak" in data:
                if "maghrib" in data:
                    data["sunset"] = data["maghrib"]
                    minutes = get_minutes_based_on_lat(lat)
                    data["maghrib_manual"] = add_minutes(data["maghrib"], minutes)
                return data
    except Exception as e:
        logging.error(f"خطا: {e}")
    return None

# کیبورد اصلی
main_keyboard = ReplyKeyboardMarkup(
    [[KeyboardButton("انتخاب شهر")]], 
    resize_keyboard=True
)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "به ربات دریافت اوقات شرعی روزانه خوش آمدید\n\n"
        "اطلاعات بر پایه سایت المهدیون میباشد.",
        reply_markup=main_keyboard
    )

async def show_cities(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.text != "انتخاب شهر":
        return
    
    cities = sorted(CITIES.keys())
    keyboard = []
    row = []
    for i, city in enumerate(cities, 1):
        row.append(InlineKeyboardButton(city, callback_data=city))
        if i % 3 == 0 or i == len(cities):
            keyboard.append(row)
            row = []
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("شهر مورد نظرت رو انتخاب کن:", reply_markup=reply_markup)

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    city = query.data
    lat, lon, timezone = CITIES[city]

    await query.edit_message_text(f"در حال دریافت اوقات شرعی {city}...")

    data = get_prayer_times(lat, lon, timezone)

    if not data:
        await query.edit_message_text("خطا در دریافت اطلاعات. چند دقیقه دیگه امتحان کن.")
        return

    date = data.get("date", datetime.now().strftime("%d/%m/%Y"))

    msg = f"اوقات شرعی امروز {city}\n{date}\n\n"
    order = ["imsak", "fajr", "sunrise", "dhuhr", "aasr", "sunset", "maghrib_manual", "midnight"]
    for key in order:
        if key in data and data[key]:
            msg += f"{PRAYER_NAMES.get(key, key)}: {data[key]}\n"

    await query.edit_message_text(msg.strip())

def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, show_cities))
    app.add_handler(CallbackQueryHandler(button_handler))
    print("ربات اوقات شرعی — با شهرهای جدید + timezone — فعال شد!")
    app.run_polling()

if __name__ == "__main__":
    main()
