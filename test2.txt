import logging
import requests
from datetime import datetime
import jdatetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from telegram import error as telegram_error

BOT_TOKEN = "8281688212:AAGRreHFJMa3hnDvv8Wsaxy4elGKui1ETDE"

CITIES = {
    "اراک": (34.0807, 49.7013), "اردبیل": (38.2500, 48.3000), "ارومیه": (37.5531, 45.0756),
    "اصفهان": (32.6539, 51.6660), "اهواز": (31.3183, 48.6706), "ایلام": (33.6341, 46.4132),
    "بجنورد": (37.4747, 57.3291), "بندرعباس": (27.1833, 56.2667), "بوشهر": (28.9684, 50.8360),
    "بیرجند": (32.8736, 59.2256), "تبریز": (38.0667, 46.3000), "تهران": (35.6892, 51.3890),
    "خرم‌آباد": (33.4878, 48.3558), "رشت": (37.2808, 49.5832), "زاهدان": (29.4963, 60.8629),
    "زنجان": (36.6756, 48.4964), "ساری": (36.5658, 53.0593), "سمنان": (35.5769, 53.3922),
    "سنندج": (35.3219, 46.9925), "شهرکرد": (32.3256, 50.8644), "شیراز": (29.5917, 52.5833),
    "قزوین": (36.2688, 50.0041), "قم": (34.6399, 50.8759), "کرج": (35.8400, 50.9391),
    "کرمان": (30.2833, 57.0833), "کرمانشاه": (34.3142, 47.0650), "گرگان": (36.8387, 54.4346),
    "مشهد": (36.2970, 59.6061), "همدان": (34.7992, 48.5147), "یاسوج": (30.6667, 51.5833),
    "یزد": (31.8974, 54.3569),
    "آزادشهر": (37.0870, 55.1742), "تربت حیدریه": (35.2740, 59.2195), "چناران": (36.6455, 59.1255),
    "دامغان": (36.1667, 54.3833), "دزفول": (32.3839747, 48.399618), "سبزوار": (36.2000, 57.7167),
    "شاهرود": (36.4182, 54.9763), "گلبهار": (36.5699, 59.1616), "ماهشهر": (30.5500, 49.1833),
    "ملایر": (34.2969, 48.8235), "میانرود": (36.5493011, 52.3385457),
    "بامیان": (34.8216, 67.8225), "غزنی": (33.5479, 68.4226), "کابل": (34.5439, 69.1607),
    "هرات": (34.3430, 62.1991),
}

logging.basicConfig(level=logging.INFO)

PRAYER_NAMES = {
    "imsak": "الإمساك (امساک)",
    "fajr": "الفجر (اذان صبح)",
    "sunrise": "الشروق (طلوع آفتاب)",
    "dhuhr": "الظهر (اذان ظهر)",
    "aasr": "العصر (اذان عصر)",
    "sunset": "غروب خورشید",
    "maghrib": "المغرب (اذان مغرب)",  # مستقیم از API
    "midnight": "منتصف الليل (نیمه‌شب شرعی)"
}

def get_prayer_times(lat: float, lon: float):
    today = datetime.now()
    url = "https://www.praytime-almahdyoon.com/api/public/prayertimes/month"  # API ماهانه
    params = {
        "languageCode": "en",
        "latitude": lat,
        "longitude": lon,
        "timezone": 3.5
    }
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "Accept": "application/json, text/plain, */*",
        "Referer": "https://www.praytime-almahdyoon.com/",
        "Origin": "https://www.praytime-almahdyoon.com",
    }

    try:
        session = requests.Session()
        session.get("https://www.praytime-almahdyoon.com/", headers=headers, timeout=10)
        r = session.get(url, params=params, headers=headers, timeout=20)
        if r.status_code == 200:
            data = r.json()
            days = data.get("days", []) if isinstance(data, dict) else data
            for day in days:
                if day.get("day") == today.day:
                    return day  # مستقیم روز جاری رو برمی‌گردونه
    except Exception as e:
        logging.error(f"خطا: {e}")
    return None

main_keyboard = ReplyKeyboardMarkup([[KeyboardButton("انتخاب شهر")]], resize_keyboard=True)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "به ربات دریافت اوقات شرعی روزانه خوش آمدید\n\nاطلاعات بر پایه سایت المهدیون میباشد.",
        reply_markup=main_keyboard
    )

async def show_cities(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.text != "انتخاب شهر":
        return
    cities = sorted(CITIES.keys())
    keyboard = []
    row = []
    for i, city in enumerate(cities, 1):
        row.append(InlineKeyboardButton(city, callback_data=city))
        if i % 3 == 0 or i == len(cities):
            keyboard.append(row)
            row = []
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("شهر مورد نظرت رو انتخاب کن:", reply_markup=reply_markup)

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    city = query.data
    lat, lon = CITIES[city]

    try:
        await query.edit_message_text(f"در حال دریافت اوقات شرعی {city}... ⏳")
    except telegram_error.BadRequest as e:
        if "Message is not modified" not in str(e):
            raise

    data = get_prayer_times(lat, lon)

    if not data:
        await query.edit_message_text("خطا در دریافت اطلاعات. چند دقیقه دیگه امتحان کن.")
        return

    # تاریخ شمسی
    jalali_date = jdatetime.datetime.now()
    persian_date = jalali_date.strftime("%d %B %Y")

    msg = f"اوقات شرعی امروز {city}\n{persian_date}\n\n"
    order = ["imsak", "fajr", "sunrise", "dhuhr", "aasr", "sunset", "maghrib", "midnight"]
    for key in order:
        if key in data and data[key]:
            msg += f"{PRAYER_NAMES.get(key, key)}: {data[key]}\n"

    await query.edit_message_text(msg.strip())

def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, show_cities))
    app.add_handler(CallbackQueryHandler(button_handler))
    print("ربات اوقات شرعی — نسخه نهایی و بدون خطا — فعال شد!")
    app.run_polling()

if __name__ == "__main__":
    main()
