import logging
import requests
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes

# ØªÙˆÚ©Ù† Ø¨Ø§Øª
BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"

# Ù…Ø®ØªØµØ§Øª Ø´Ù‡Ø±Ù‡Ø§
CITIES = {
    "ØªÙ‡Ø±Ø§Ù†":   (35.7218583, 51.3346954),
    "Ù…Ø´Ù‡Ø¯":    (36.2970000, 59.6061000),
    "Ø§ØµÙÙ‡Ø§Ù†":  (32.6539000, 51.6660000),
    "ØªØ¨Ø±ÛŒØ²":   (38.0667000, 46.3000000),
    "Ø§Ù‡ÙˆØ§Ø²":   (31.3183000, 48.6706000),
    "Ú¯Ø±Ù…Ø³Ø§Ø±": (35.2167000, 52.3167000),
}

logging.basicConfig(level=logging.INFO)

# Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚ (Ø§Ø² Ù…Ø§Ù‡Ø§Ù†Ù‡ â€“ Ù…ØºØ±Ø¨ Ø´Ø±Ø¹ÛŒØŒ + ØºØ±ÙˆØ¨ Ùˆ Ø¹Ø´Ø§Ø¡)
PRAYER_NAMES = {
    "imsak":          "Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ (Ø§Ù…Ø³Ø§Ú©)",
    "fajr":           "Ø§Ù„ÙØ¬Ø± (Ø§Ø°Ø§Ù† ØµØ¨Ø­)",
    "sunrise":        "Ø§Ù„Ø´Ø±ÙˆÙ‚ (Ø·Ù„ÙˆØ¹ Ø¢ÙØªØ§Ø¨)",
    "sunset":         "ØºØ±ÙˆØ¨ (Ù†Ø¬ÙˆÙ…ÛŒ)",  # â† Ø¬Ø¯Ø§ Ø§Ø² Ù…ØºØ±Ø¨
    "dhuhr":          "Ø§Ù„Ø¸Ù‡Ø± (Ø§Ø°Ø§Ù† Ø¸Ù‡Ø±)",
    "aasr":           "Ø§Ù„Ø¹ØµØ± (Ø§Ø°Ø§Ù† Ø¹ØµØ±)",
    "maghrib":        "Ø§Ù„Ù…ØºØ±Ø¨ (Ø§Ø°Ø§Ù† Ù…ØºØ±Ø¨ Ø´Ø±Ø¹ÛŒ)",  # â† Ø¯Ø±Ø³Øª Ø§Ø² Ù…Ø§Ù‡Ø§Ù†Ù‡ (17:06)
    "ishaa":          "Ø§Ù„Ø¹Ø´Ø§Ø¡ (Ø§Ø°Ø§Ù† Ø¹Ø´Ø§Ø¡)",  # Ø§Ú¯Ø± Ø¨Ø®ÙˆØ§ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
    "ishaa_fadilah":  "ÙØ¶ÛŒÙ„Øª Ø¹Ø´Ø§Ø¡",  # Ø§Ú¯Ø± Ø¨Ø®ÙˆØ§ÛŒ
    "midnight":       "Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ (Ù†ÛŒÙ…Ù‡â€ŒØ´Ø¨ Ø´Ø±Ø¹ÛŒ)"
}

def get_prayer_times_monthly(lat: float, lon: float):
    """Ø§Ø² API Ù…Ø§Ù‡Ø§Ù†Ù‡ â€“ Ú©Ø§Ù…Ù„â€ŒØªØ± Ùˆ Ù…ØºØ±Ø¨ Ø¯Ø±Ø³Øª"""
    today = datetime.now()
    url = "https://www.praytime-almahdyoon.com/api/public/prayertimes/month"
    params = {
        "languageCode": "en",
        "latitude": lat,
        "longitude": lon,
        "timezone": 3.5
    }
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "Accept": "application/json, text/plain, */*",
        "Referer": "https://www.praytime-almahdyoon.com/",
        "Origin": "https://www.praytime-almahdyoon.com",
        "Sec-Fetch-Mode": "cors",
        "Sec-Fetch-Site": "same-origin"
    }

    try:
        session = requests.Session()
        session.get("https://www.praytime-almahdyoon.com/", headers=headers, timeout=10)
        r = session.get(url, params=params, headers=headers, timeout=15)
        if r.status_code == 200:
            data = r.json()
            # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø±ÙˆØ² Ø¬Ø§Ø±ÛŒ Ø¯Ø± Ù…Ø§Ù‡Ø§Ù†Ù‡ (Ù„ÛŒØ³Øª Ø±ÙˆØ²Ù‡Ø§)
            for day_data in data.get("days", []):
                if day_data.get("day") == today.day:
                    return day_data  # Ø§ÙˆÙ‚Ø§Øª Ø±ÙˆØ² Ø¬Ø§Ø±ÛŒ
    except Exception as e:
        logging.error(f"Ø®Ø·Ø§: {e}")
    return None

# /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("ØªÙ‡Ø±Ø§Ù†", callback_data="ØªÙ‡Ø±Ø§Ù†")],
        [InlineKeyboardButton("Ù…Ø´Ù‡Ø¯", callback_data="Ù…Ø´Ù‡Ø¯")],
        [InlineKeyboardButton("Ø§ØµÙÙ‡Ø§Ù†", callback_data="Ø§ØµÙÙ‡Ø§Ù†")],
        [InlineKeyboardButton("ØªØ¨Ø±ÛŒØ²", callback_data="ØªØ¨Ø±ÛŒØ²")],
        [InlineKeyboardButton("Ø§Ù‡ÙˆØ§Ø²", callback_data="Ø§Ù‡ÙˆØ§Ø²")],
        [InlineKeyboardButton("Ú¯Ø±Ù…Ø³Ø§Ø±", callback_data="Ú¯Ø±Ù…Ø³Ø§Ø±")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        "Ø³Ù„Ø§Ù…! ğŸŒ™ Ø§ÙˆÙ‚Ø§Øª Ø´Ø±Ø¹ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø§Ø² praytime-almahdyoon.com (Ø§Ø² Ø¨Ø®Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡ â€“ Ú©Ø§Ù…Ù„â€ŒØªØ±)\n\n"
        "Ø´Ù‡Ø± Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:",
        reply_markup=reply_markup
    )

# Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    city = query.data
    lat, lon = CITIES[city]

    await query.edit_message_text(f"Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§ÙˆÙ‚Ø§Øª Ø´Ø±Ø¹ÛŒ {city}... â³")

    data = get_prayer_times_monthly(lat, lon)

    if not data:
        await query.edit_message_text("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª. Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ù‡ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.")
        return

    date = data.get("date", datetime.now().strftime("%d/%m/%Y"))

    msg = f"Ø§ÙˆÙ‚Ø§Øª Ø´Ø±Ø¹ÛŒ Ø§Ù…Ø±ÙˆØ² {city}\n{date}\n\n"
    # ØªØ±ØªÛŒØ¨ (Ø¨Ø§ ØºØ±ÙˆØ¨ Ø¬Ø¯Ø§ØŒ Ù…ØºØ±Ø¨ Ø´Ø±Ø¹ÛŒØŒ + Ø¹Ø´Ø§Ø¡ Ø§Ú¯Ø± Ø¨Ø®ÙˆØ§ÛŒ)
    order = ["imsak", "fajr", "sunrise", "sunset", "dhuhr", "aasr", "maghrib", "ishaa", "midnight"]
    for key in order:
        if key in data and data[key]:
            msg += f"{PRAYER_NAMES[key]}: {data[key]}\n"

    await query.edit_message_text(msg.strip())

def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(button_handler))
    print("Ø¨Ø§Øª Ø§ÙˆÙ‚Ø§Øª Ø´Ø±Ø¹ÛŒ (Ø§Ø² Ù…Ø§Ù‡Ø§Ù†Ù‡ â€“ Ù…ØºØ±Ø¨ Ø¯Ø±Ø³Øª) ÙØ¹Ø§Ù„ Ø´Ø¯!")
    app.run_polling()

if __name__ == "__main__":
    main()
