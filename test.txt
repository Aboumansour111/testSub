from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes
from datetime import datetime
import time

# ØªÙˆÚ©Ù† Ø¨Ø§Øª
BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"

# Ø¯ÛŒÚ©Ø´Ù†Ø±ÛŒ Ø´Ù‡Ø±Ù‡Ø§ Ø¨Ø§ Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÛŒ input (Ø§Ø² Ø³Ø§ÛŒØª)
CITY_TEXTS = {
    "ØªÙ‡Ø±Ø§Ù†": "ØªÙ‡Ø±Ø§Ù†ØŒ Tehran Province, Iran",
    "Ù…Ø´Ù‡Ø¯": "Ù…Ø´Ù‡Ø¯ØŒ Razavi Khorasan Province, Iran",
    "Ø§ØµÙÙ‡Ø§Ù†": "Ø§ØµÙÙ‡Ø§Ù†ØŒ Isfahan Province, Iran",
    "ØªØ¨Ø±ÛŒØ²": "ØªØ¨Ø±ÛŒØ²ØŒ East Azerbaijan Province, Iran",
    "Ø§Ù‡ÙˆØ§Ø²": "Ø§Ù‡ÙˆØ§Ø²ØŒ Khuzestan Province, Iran",
    "Ú¯Ø±Ù…Ø³Ø§Ø±": "Ú¯Ø±Ù…Ø³Ø§Ø±ØŒ Semnan Province, Iran"
}

def get_prayer_times(city_text: str):
    """Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§ÙˆÙ‚Ø§Øª Ø§Ø² ØµÙØ­Ù‡ Ø³Ø§ÛŒØª Ø¨Ø§ Selenium"""
    options = Options()
    options.add_argument("--headless")  # Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø±ÙˆØ±Ú¯Ø±
    options.add_argument("--no-sandbox")
    options.add_argument("--disable-dev-shm-usage")
    
    driver = webdriver.Chrome(options=options)
    try:
        driver.get("https://www.praytime-almahdyoon.com/")
        wait = WebDriverWait(driver, 10)
        
        # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† input Ø´Ù‡Ø±
        input_city = wait.until(EC.presence_of_element_located((By.CLASS_NAME, "pac-input")))
        input_city.clear()
        input_city.send_keys(city_text)
        time.sleep(2)  # ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ autocomplete
        
        # Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÙˆÙ„ÛŒÙ† Ù†ØªÛŒØ¬Ù‡ (ÛŒØ§ Ø§ÛŒÙ†ØªØ±)
        input_city.send_keys(Keys.ENTER)
        time.sleep(3)  # ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ Ø§ÙˆÙ‚Ø§Øª
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¬Ø¯ÙˆÙ„
        table = driver.find_element(By.TAG_NAME, "table")
        rows = table.find_elements(By.TAG_NAME, "tr")[1:]  # Ø±Ø¯ header
        times = {}
        headers = ["date", "imsak", "fajr", "sunrise", "dhuhr", "aasr", "maghrib", "midnight"]
        for i, row in enumerate(rows):
            cols = row.find_elements(By.TAG_NAME, "td")
            if len(cols) >= 8:
                times[headers[i]] = cols[1].text.strip()  # Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ Ø§Ø² Ø³ØªÙˆÙ† Ø¯ÙˆÙ…
        
        return times
    except Exception as e:
        print(f"Ø®Ø·Ø§ Ø¯Ø± Selenium: {e}")
        return None
    finally:
        driver.quit()

# /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("ØªÙ‡Ø±Ø§Ù†", callback_data="ØªÙ‡Ø±Ø§Ù†")],
        [InlineKeyboardButton("Ù…Ø´Ù‡Ø¯", callback_data="Ù…Ø´Ù‡Ø¯")],
        [InlineKeyboardButton("Ø§ØµÙÙ‡Ø§Ù†", callback_data="Ø§ØµÙÙ‡Ø§Ù†")],
        [InlineKeyboardButton("ØªØ¨Ø±ÛŒØ²", callback_data="ØªØ¨Ø±ÛŒØ²")],
        [InlineKeyboardButton("Ø§Ù‡ÙˆØ§Ø²", callback_data="Ø§Ù‡ÙˆØ§Ø²")],
        [InlineKeyboardButton("Ú¯Ø±Ù…Ø³Ø§Ø±", callback_data="Ú¯Ø±Ù…Ø³Ø§Ø±")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        "Ø³Ù„Ø§Ù…! ğŸŒ™ Ø§ÙˆÙ‚Ø§Øª Ø´Ø±Ø¹ÛŒ Ø§Ø² praytime-almahdyoon.com (Ø¨Ø§ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±)\n\n"
        "Ø´Ù‡Ø± Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:",
        reply_markup=reply_markup
    )

# Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    city = query.data
    city_text = CITY_TEXTS[city]

    await query.edit_message_text(f"Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§ÙˆÙ‚Ø§Øª Ø´Ø±Ø¹ÛŒ {city}... â³")

    data = get_prayer_times(city_text)

    if not data:
        await query.edit_message_text(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§ÙˆÙ‚Ø§Øª {city}. ChromeDriver Ø±Ùˆ Ú†Ú© Ú©Ù† ÛŒØ§ VPN Ø¨Ø²Ù†.")
        return

    date = data.get("date", datetime.now().strftime("%d/%m/%Y"))

    msg = f"Ø§ÙˆÙ‚Ø§Øª Ø´Ø±Ø¹ÛŒ Ø§Ù…Ø±ÙˆØ² {city}\n{date}\n\n"
    order = ["imsak", "fajr", "sunrise", "dhuhr", "aasr", "maghrib", "midnight"]
    PRAYER_NAMES = {
        "imsak": "Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ (Ø§Ù…Ø³Ø§Ú©)",
        "fajr": "Ø§Ù„ÙØ¬Ø± (Ø§Ø°Ø§Ù† ØµØ¨Ø­)",
        "sunrise": "Ø§Ù„Ø´Ø±ÙˆÙ‚ (Ø·Ù„ÙˆØ¹ Ø¢ÙØªØ§Ø¨)",
        "dhuhr": "Ø§Ù„Ø¸Ù‡Ø± (Ø§Ø°Ø§Ù† Ø¸Ù‡Ø±)",
        "aasr": "Ø§Ù„Ø¹ØµØ± (Ø§Ø°Ø§Ù† Ø¹ØµØ±)",
        "maghrib": "Ø§Ù„Ù…ØºØ±Ø¨ (Ø§Ø°Ø§Ù† Ù…ØºØ±Ø¨)",
        "midnight": "Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ (Ù†ÛŒÙ…Ù‡â€ŒØ´Ø¨ Ø´Ø±Ø¹ÛŒ)"
    }
    for key in order:
        if key in data:
            msg += f"{PRAYER_NAMES.get(key, key)}: {data[key]}\n"

    await query.edit_message_text(msg.strip())

def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(button_handler))
    print("Ø¨Ø§Øª Ø¨Ø§ Selenium ÙØ¹Ø§Ù„ Ø´Ø¯ â€“ ChromeDriver Ø±Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†!")
    app.run_polling()

if __name__ == "__main__":
    main()
