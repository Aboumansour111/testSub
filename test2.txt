import logging
import requests
from datetime import datetime
import jdatetime
import pytz
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from telegram import error as telegram_error

BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"  # توکنت رو اینجا بذار

CITIES_SEARCH = {
    "اراک": "اراک، Markazi Province, Iran",
    "اردبیل": "اردبیل، Ardabil Province, Iran",
    "ارومیه": "ارومیه، West Azerbaijan Province, Iran",
    "اصفهان": "اصفهان، Isfahan Province, Iran",
    "اهواز": "اهواز، Khuzestan Province, Iran",
    "ایلام": "ایلام، Ilam Province, Iran",
    "بجنورد": "بجنورد، North Khorasan Province, Iran",
    "بندرعباس": "بندرعباس، Hormozgan Province, Iran",
    "بوشهر": "بوشهر، Bushehr Province, Iran",
    "بیرجند": "بیرجند، South Khorasan Province, Iran",
    "تبریز": "تبریز، East Azerbaijan Province, Iran",
    "تهران": "تهران، Tehran Province, Iran",
    "خرم‌آباد": "خرم‌آباد، Lorestan Province, Iran",
    "رشت": "رشت، Gilan Province, Iran",
    "زاهدان": "زاهدان، Sistan and Baluchestan Province, Iran",
    "زنجان": "زنجان، Zanjan Province, Iran",
    "ساری": "ساری، Mazandaran Province, Iran",
    "سمنان": "سمنان، Semnan Province, Iran",
    "سنندج": "سنندج، Kurdistan Province, Iran",
    "شهرکرد": "شهرکرد، Chaharmahal and Bakhtiari Province, Iran",
    "شیراز": "شیراز، Fars Province, Iran",
    "قزوین": "قزوین، Qazvin Province, Iran",
    "قم": "قم، Qom Province, Iran",
    "کرج": "کرج، Alborz Province, Iran",
    "کرمان": "کرمان، Kerman Province, Iran",
    "کرمانشاه": "کرمانشاه، Kermanshah Province, Iran",
    "گرگان": "گرگان، Golestan Province, Iran",
    "مشهد": "مشهد، Razavi Khorasan Province, Iran",
    "همدان": "همدان، Hamadan Province, Iran",
    "یاسوج": "یاسوج، Kohgiluyeh and Boyer-Ahmad Province, Iran",
    "یزد": "یزد، Yazd Province, Iran",
    "آزادشهر": "آزادشهر، Golestan Province, Iran",
    "تربت حیدریه": "تربت حیدریه، Razavi Khorasan Province, Iran",
    "چناران": "چناران، Razavi Khorasan Province, Iran",
    "دامغان": "دامغان، Semnan Province, Iran",
    "دزفول": "دزفول، Khuzestan Province, Iran",
    "سبزوار": "سبزوار، Razavi Khorasan Province, Iran",
    "شاهرود": "شاهرود، Semnan Province, Iran",
    "گلبهار": "گلبهار، Razavi Khorasan Province, Iran",
    "ماهشهر": "ماهشهر، Khuzestan Province, Iran",
    "ملایر": "ملایر، Hamadan Province, Iran",
    "میانرود": "میانرود، Mazandaran Province, Iran",
    "بامیان": "بامیان، Bamyan, Afghanistan",
    "غزنی": "غزنی، Ghazni, Afghanistan",
    "کابل": "کابل، Kabul, Afghanistan",
    "هرات": "هرات، Herat, Afghanistan",
}

logging.basicConfig(level=logging.INFO)

PRAYER_NAMES = {
    "imsak": "الإمساك (امساک)",
    "fajr": "الفجر (اذان صبح)",
    "sunrise": "الشروق (طلوع آفتاب)",
    "dhuhr": "الظهر (اذان ظهر)",
    "aasr": "العصر (اذان عصر)",
    "sunset": "غروب خورشید",
    "maghrib": "المغرب (اذان مغرب)",
    "midnight": "منتصف الليل (نیمه‌شب شرعی)"
}

def get_maghrib_from_page(city_search_text: str) -> str:
    options = Options()
    options.add_argument("--headless=new")
    options.add_argument("--no-sandbox")
    options.add_argument("--disable-dev-shm-usage")
    options.add_argument("--disable-gpu")
    options.add_argument("--window-size=1920,1080")
    driver = webdriver.Chrome(options=options)
    try:
        driver.get("https://www.praytime-almahdyoon.com/")
        wait = WebDriverWait(driver, 20)
        input_city = wait.until(EC.element_to_be_clickable((By.CLASS_NAME, "pac-input")))
        input_city.clear()
        input_city.send_keys(city_search_text)
        input_city.send_keys(Keys.ENTER)
        wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, "table.md-table")))
        cells = driver.find_elements(By.CSS_SELECTOR, "td.md-table-cell .md-table-cell-container")
        if len(cells) >= 7:
            return cells[6].text.strip()
    except Exception as e:
        logging.error(f"خطا در Selenium: {e}")
    finally:
        driver.quit()
    return "نامشخص"

main_keyboard = ReplyKeyboardMarkup([[KeyboardButton("انتخاب شهر")]], resize_keyboard=True)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "به ربات دریافت اوقات شرعی روزانه خوش آمدید\n\nاطلاعات بر پایه سایت المهدیون میباشد.",
        reply_markup=main_keyboard
    )

async def show_cities(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.text != "انتخاب شهر":
        return
    cities = sorted(CITIES_SEARCH.keys())
    keyboard = []
    row = []
    for i, city in enumerate(cities, 1):
        row.append(InlineKeyboardButton(city, callback_data=city))
        if i % 3 == 0 or i == len(cities):
            keyboard.append(row)
            row = []
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("شهر مورد نظرت رو انتخاب کن:", reply_markup=reply_markup)

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    city = query.data
    city_search = CITIES_SEARCH[city]

    try:
        await query.edit_message_text(f"در حال دریافت اوقات شرعی {city}... ⏳")
    except telegram_error.BadRequest as e:
        if "Message is not modified" not in str(e):
            raise

    # مغرب مستقیم از صفحه سایت
    maghrib = get_maghrib_from_page(city_search)

    # بقیه اوقات رو از API می‌گیریم (سریع‌تر)
    # برای این نسخه، lat/lon لازم نیست چون فقط مغرب از صفحه می‌گیریم
    # اگر خواستی بقیه رو هم از صفحه بگیری، بگو

    # برای این نسخه، فقط مغرب از صفحه، بقیه رو از API (اگر lat/lon داری)
    # اما برای ساده بودن، فقط مغرب نشون می‌دیم تا تست کنی
    tehran_tz = pytz.timezone('Asia/Tehran')
    now_tehran = datetime.now(tehran_tz)
    jalali_date = jdatetime.datetime.fromgregorian(datetime=now_tehran)
    persian_date = jalali_date.strftime("%d %B %Y")

    msg = f"اوقات شرعی امروز {city}\n{persian_date}\n\n"
    msg += f"المغرب (اذان مغرب): {maghrib}\n"

    await query.edit_message_text(msg.strip())

def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, show_cities))
    app.add_handler(CallbackQueryHandler(button_handler))
    print("ربات اوقات شرعی — با مغرب دقیق از صفحه — فعال شد!")
    app.run_polling()

if __name__ == "__main__":
    main()
